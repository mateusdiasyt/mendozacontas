// MendozaContas - Schema Prisma
// Compatível com Neon.tech (PostgreSQL) e deploy Vercel

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========== ENUMS (regras de negócio) ==========

enum Contexto {
  PESSOAL
  ARCADE
}

enum TipoReceita {
  FIXA
  EXTRA
  ARCADE_DIARIA
  REPASSE
}

enum FormaPagamento {
  PIX
  DINHEIRO
  CARTAO
}

// ========== USUÁRIO ==========

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  passwordHash String
  nome         String?
  isAdmin      Boolean   @default(false)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  receitas          Receita[]
  despesas          Despesa[]
  cartoes           Cartao[]
  lancamentosCartao LancamentoCartao[]
  repasses          Repasse[]
}

// ========== RECEITAS ==========
// Extras de programação → PESSOAL. Arcade diária → conforme contexto.

model Receita {
  id         String      @id @default(cuid())
  descricao  String
  valor      Decimal     @db.Decimal(12, 2)
  data       DateTime    @db.Date
  tipo       TipoReceita
  contexto   Contexto
  observacao String?
  userId     String
  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  repasseId  String?     @unique
  repasse    Repasse?    @relation(fields: [repasseId], references: [id], onDelete: SetNull)
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  @@index([userId, contexto, data])
}

// ========== DESPESAS ==========

model Despesa {
  id              String         @id @default(cuid())
  descricao       String
  valor           Decimal        @db.Decimal(12, 2)
  categoria       String
  data            DateTime       @db.Date
  formaPagamento  FormaPagamento
  contexto        Contexto
  recorrente      Boolean        @default(false)
  userId          String
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  repasseId       String?        @unique
  repasse         Repasse?       @relation(fields: [repasseId], references: [id], onDelete: SetNull)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([userId, contexto, data])
}

// ========== CARTÕES DE CRÉDITO ==========
// Fatura = soma dos lançamentos do ciclo (fechamento → vencimento).

enum LayoutCartao {
  GENERICO
  NUBANK
  ITAU
}

model Cartao {
  id          String        @id @default(cuid())
  nome        String
  limite      Decimal       @db.Decimal(12, 2)
  fechamento  Int           // dia do mês 1-31
  vencimento  Int           // dia do mês 1-31
  layout      LayoutCartao  @default(GENERICO)
  contexto    Contexto
  userId      String
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  lancamentos LancamentoCartao[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([userId, contexto])
}

// ========== LANÇAMENTOS DE CARTÃO ==========
// Cada compra é um lançamento; fatura calculada automaticamente.

model LancamentoCartao {
  id           String   @id @default(cuid())
  descricao    String
  valor        Decimal  @db.Decimal(12, 2)
  parcelas     Int      @default(1)
  parcelaAtual Int      @default(1)
  cartaoId     String
  cartao       Cartao   @relation(fields: [cartaoId], references: [id], onDelete: Cascade)
  categoria    String
  dataCompra   DateTime @db.Date
  contexto     Contexto
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([cartaoId, dataCompra])
  @@index([userId, contexto])
}

// ========== REPASSE (ARCADE → PESSOAL) ==========
// Ao criar: gera 1 Despesa (ARCADE) + 1 Receita (PESSOAL, tipo REPASSE).

model Repasse {
  id        String   @id @default(cuid())
  valor     Decimal  @db.Decimal(12, 2)
  data      DateTime @default(now())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  receita   Receita?
  despesa   Despesa?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, data])
}

// ========== CONFIGURAÇÕES (admin) ==========
// Chaves de API e outras configs; só editável por admin.

model Setting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt
}
